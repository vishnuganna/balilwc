/*******************************************************************************************
 * @Name         CriticalVulnerabilityController
 * @Author       Monika Deshmukh
 * @Date         2020-07-20
 * @Group
 * @Description  KFS-331 - This class contains all methods related to create,get and update critical vulnerability record update
 *******************************************************************************************/
/* MODIFICATION LOG
 * Version          Developer          Date               Description
 *-------------------------------------------------------------------------------------------
 *  1.0             Monika Deshmukh     2020-07-20          Initial Creation
 *********************************************************************
 */
public with sharing class CriticalVulnerabilityController {
    /* @Description this method is used to get the Ciritcal vulnerability data
     * @Return - it retuns data from wrapper*/
    static String vulnerabilityApiName = 'vulnerablity';

    @AuraEnabled
    public static CriticalVulnerabilityWrapper getVulnerabilityData(String goldsheetId) {
        List<Gold_Sheet__c> listGoldSheet = new List<Gold_Sheet__c>();
        Boolean isUpdatable = false;
        if (Schema.sObjectType.Gold_Sheet__c.isUpdateable()) {
            isUpdatable = true;
        }
        String query = 'SELECT Id,Name,Critical_Vulnerability_Desc__c,Critical_Vulnerability_Title__c FROM Gold_Sheet__c WHERE Id =:goldsheetId';
        Map<String, Object> paramters = new Map<String, Object>();
        paramters.put('goldsheetId', goldsheetId);
        listGoldSheet = DataFactory.read(query, paramters);
        CriticalVulnerabilityWrapper wrapper;
        if (!listGoldSheet.isEmpty()) {
            wrapper = new CriticalVulnerabilityWrapper(listGoldSheet[0], isUpdatable);
            List<RedFlagStrengthMarkerWrapper> rfsWrapperList = new List<RedFlagStrengthMarkerWrapper>();
            String sourceId = listGoldSheet[0].Id;
            rfsWrapperList = RedFlagStrengthData.getRFSWrapperList(sourceId);

            wrapper.rfsMarkerWrapper = rfsWrapperList;
        }
        return wrapper;
    }

    /* @Description this method is used to save the Ciritcal vulnerability data
     * @Return -  return wrapper to show data */

    @AuraEnabled
    public static CriticalVulnerabilityWrapper saveVulnerabilityData(
        String inputString,
        Map<String, Map<String, Object>> rfsMap
    ) {
        List<Gold_Sheet__c> goldsheetRec = new List<Gold_Sheet__c>();
        CriticalVulnerabilityWrapper wrapper = (CriticalVulnerabilityWrapper) System.JSON.deserialize(
            inputString,
            CriticalVulnerabilityWrapper.class
        );
        String goldsheetId = wrapper.goldsheetId;
        if (wrapper != null) {
            String query = 'SELECT Id,Name,Critical_Vulnerability_Desc__c,Critical_Vulnerability_Title__c FROM Gold_Sheet__c WHERE Id =:goldsheetId';
            Map<String, Object> paramters = new Map<String, Object>();
            paramters.put('goldsheetId', goldsheetId);
            goldsheetRec = DataFactory.read(query, paramters);
            if (goldsheetRec != null) {
                goldsheetRec[0].Critical_Vulnerability_Desc__c = wrapper.description;
                goldsheetRec[0].Critical_Vulnerability_Title__c = wrapper.title;
            }
            List<Database.SaveResult> srList = DataFactory.modify(goldsheetRec);
            List<RedFlagStrengthMarkerWrapper> rfsWrapperList = new List<RedFlagStrengthMarkerWrapper>();
            rfsWrapperList = RedFlagStrengthData.getRFSWrapperList(goldsheetRec[0].Id);
            String objectApiName = util.getNamespaceWithUnderScores() == ''
                ? 'Gold_Sheet__c'
                : util.getNamespaceWithUnderScores() + 'Gold_Sheet__c';
            if (!rfsWrapperList.isEmpty()) {
                ApexCommonUtil.convertMarkerMap(rfsWrapperList, rfsMap);
                rfsWrapperList = RedFlagStrengthData.updateRedFlagStrengthRecords(
                    objectApiName,
                    goldsheetId,
                    goldsheetId,
                    rfsMap
                );
            } else {
                List<Red_Flag_Strength_Marker__c> markerList = RedFlagStrengthData.createRFSrecords(
                    goldsheetId,
                    objectApiName,
                    rfsMap
                );
                //This list srList will have only one record at a time
                for (Database.SaveResult sr : srList) {
                    if (sr.isSuccess()) {
                        DataFactory.create(markerList);
                    }
                    List<Red_Flag_Strength_Marker__c> markerListUpdated = new List<Red_Flag_Strength_Marker__c>();
                    for (Red_Flag_Strength_Marker__c marker : markerList) {
                        marker.Source_ID__c = srList[0].getId();
                        markerListUpdated.add(marker);
                    }
                    DataFactory.modify(markerListUpdated);
                }
            }
            wrapper = getVulnerabilityData(goldsheetId);
            return wrapper;
        } else {
            throw new AuraHandledException('error in updating record');
        }
    }

    /* delete functionality to update the gold sheet record to null values */
    @AuraEnabled
    public static void deleteCriticalVulnerability(String goldsheetId) {
        List<Gold_Sheet__c> goldsheetRec = new List<Gold_Sheet__c>();
        String query = 'SELECT Id,Name,Critical_Vulnerability_Desc__c,Critical_Vulnerability_Title__c FROM Gold_Sheet__c WHERE Id =:goldsheetId';
        Map<String, Object> paramters = new Map<String, Object>();
        paramters.put('goldsheetId', goldsheetId);
        goldsheetRec = DataFactory.read(query, paramters);
        if (goldsheetRec != null) {
            goldsheetRec[0].Critical_Vulnerability_Desc__c = '';
            goldsheetRec[0].Critical_Vulnerability_Title__c = '';
        }
        List<Database.SaveResult> srList = DataFactory.modify(goldsheetRec);
        //Delete red flag/Strength marker record from backend
        List<Red_Flag_Strength_Marker__c> rfsRecords = RedFlagStrengthData.getRFSrecords(goldsheetRec[0].Id);
        List<Red_Flag_Strength_Marker__c> rfsRecordsUpdated = new List<Red_Flag_Strength_Marker__c>();
        for (Red_Flag_Strength_Marker__c rfsRecord : rfsRecords) {
            if (rfsRecord.Field_API_Name__c == vulnerabilityApiName) {
                rfsRecordsUpdated.add(rfsRecord);
            }
        }
        //This list srList will have only one record at a time
        for (Database.SaveResult sr : srList) {
            if (sr.isSuccess()) {
                DataFactory.remove(rfsRecordsUpdated);
            }
        }
    }
}